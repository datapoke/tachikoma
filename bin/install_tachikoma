#!/bin/sh -e
config=$1
if [ -z "$config" ] ; then
    config=default
fi
if [ ! -d lib/Tachikoma/Nodes ] ; then
    echo ERROR: must be run from within tachikoma distribution.
    exit 1
fi
set -x

# perl modules
perl Makefile.PL
make
make test
sudo make install
make clean
rm -f Makefile.old

# make dirs
mkdir -p ~/.tachikoma/
mkdir -p ~/.tachikoma/etc/
mkdir -p ~/.tachikoma/http/
mkdir -p ~/.tachikoma/log/
mkdir -p ~/.tachikoma/partitions/
mkdir -p ~/.tachikoma/pool/
mkdir -p ~/.tachikoma/run/
mkdir -p ~/.tachikoma/services/

# server config
cp -v etc/Devel/tachikoma.conf ~/.tachikoma/etc/

# private key
bin/gen_server_key ~/.tachikoma/etc/id 2048 ignore

# HTTP
cp -v etc/Devel/CGI.conf ~/.tachikoma/etc/
cp -rv http/* ~/.tachikoma/http/

# init scripts
etc/scripts/regenerate.pl
cp -v etc/scripts/workstation/$config.tsl    ~/.tachikoma/startup.txt
cp -v etc/scripts/workstation/services/*.tsl ~/.tachikoma/services/

# authorized keys
etc/authorized_keys/regenerate.pl
cp -v etc/authorized_keys/workstation.keys ~/.tachikoma/etc/authorized_keys

# TLS
if [ ! -d ~/.tachikoma/tls ] ; then
    mkdir -p tls.new
    cd tls.new
    openssl genrsa -out ca.key 2048
    openssl req -new -x509 -days 3653 -key ca.key -out ca.crt -config ../etc/tls/ca.conf
    openssl req -new -out server.csr -config ../etc/tls/csr.conf
    openssl x509 -req -days 3653 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -extfile ../etc/tls/v3.ext
    cd ..
    mv tls.new ~/.tachikoma/tls
fi
