#!/bin/sh -e
config=$1
if [ -z "$config" ] ; then
    config=default
fi
if [ ! -d lib/Tachikoma/Nodes ] ; then
    echo ERROR: must be run from within tachikoma distribution.
    exit 1
fi
set -x

# perl modules
perl Makefile.PL
make
make test
if [ -x /usr/bin/sudo ] ; then
    sudo make install
else
    make install
fi
make clean
rm -f Makefile.old

# make dirs
mkdir -p ~/.tachikoma/
mkdir -p ~/.tachikoma/etc/
mkdir -p ~/.tachikoma/http/
mkdir -p ~/.tachikoma/log/
mkdir -p ~/.tachikoma/partitions/
mkdir -p ~/.tachikoma/pool/
mkdir -p ~/.tachikoma/run/
mkdir -p ~/.tachikoma/services/
mkdir -p ~/.tachikoma/pki/

# server config
cp -v etc/Devel/tachikoma.conf ~/.tachikoma/etc/

# private key
bin/gen_server_key ~/.tachikoma/etc/id 2048 ignore

# HTTP
cp -v etc/Devel/CGI.conf ~/.tachikoma/etc/
cp -rv http/* ~/.tachikoma/http/

# init scripts
etc/scripts/regenerate.pl
cp -v etc/scripts/workstation/$config.tsl    ~/.tachikoma/startup.txt
cp -v etc/scripts/workstation/services/*.tsl ~/.tachikoma/services/

# authorized keys
etc/authorized_keys/regenerate.pl
cp -v etc/authorized_keys/workstation.keys ~/.tachikoma/etc/authorized_keys

# TLS
cp -rv etc/pki ~/.tachikoma/
if [ ! -d ~/.tachikoma/tls ] ; then
    cd ~/.tachikoma/pki
    ./genkey $config server
    mv tls/$config ~/.tachikoma/tls
fi
