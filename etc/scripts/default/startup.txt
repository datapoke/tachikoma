#!/usr/bin/env /usr/local/bin/tachikoma

# TRIGGER:
# http://localhost:4242/trigger/IMG001.JPG
 
# STORE:
# curl --data-binary @Pictures/IMG001.JPG -X POST \
#     http://localhost:4242/store/topic1/IMG001.JPG

# FETCH:
# http://localhost:4242/topic1:table/IMG001.JPG


# persistent storage
var home     = `echo ~`;
var hostname = `hostname -s`;
make_node Broker broker localhost:5501 <home>/.tachikoma/pool
cd broker
    set_broker localhost:5501 <home>/.tachikoma/pool
    set_topic topic1 --num_partitions=1                                 \
                     --replication_factor=1
    set_group cache  --topic=topic1
    start_broker
cd ..
listen_inet 127.0.0.1:5501


# in-memory cache
connect_inet localhost:5501 localhost:5501
make_node ConsumerBroker topic1:consumer --broker=localhost:5501/broker \
                                         --topic=topic1                 \
                                         --group=cache                  \
                                         --default_offset=start         \
                                         --max_unanswered=0
make_node Tee            topic1:tee
make_node Table          topic1:table    --window_size=0                \
                                         --num_buckets=1
make_node HTTP_Trigger   topic1:dir      /trigger 
connect_edge topic1:dir      topic1:table
connect_node topic1:tee      topic1:table
connect_node topic1:tee      topic1:dir
connect_node topic1:consumer topic1:tee
connect_edge topic1:consumer topic1:table


# http interface
make_node HTTP_Responder http:responder /tmp/http 4242
make_node HTTP_Timeout   http:timeout
make_node Tee            access:log
make_node HTTP_Route     root
make_node HTTP_Fetch     root:dir       /         topic1:table
make_node HTTP_Store     store:dir      /tmp/http /store topic1
make_node HTTP_Sigma     sigma
make_node Topic          topic1         localhost:5501/broker
command root add /        root:dir
command root add /store   store:dir
command root add /sigma   sigma
command root add /trigger topic1:dir
connect_node http:responder root
listen_inet --io 127.0.0.1:4242
connect_sink 127.0.0.1:4242 http:responder

# server log
make_node Tail    server_log:tail <home>/.tachikoma/log/tachikoma-server.log
make_node Ruleset server_log:ruleset
make_node Tee     server_log
cd server_log:ruleset:config
    add  100 cancel where payload=".* FROM: .* ID: tachikoma@<hostname>(?:[.].*)? COMMAND: .*"
    add 1000 allow
cd ..
connect_node server_log:ruleset server_log
connect_node server_log:tail    server_log:ruleset

secure 2
