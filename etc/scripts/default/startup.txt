#!/usr/bin/env /usr/local/bin/tachikoma

# STORE:
# curl --data-binary @Pictures/IMG001.JPG -X POST \
#     http://localhost:4242/store/topic1/IMG001.JPG

# FETCH:
# http://localhost:4242/topic1:table/IMG001.JPG


# persistent storage
var home = `echo ~`;
make_node Broker broker localhost:4230 <home>/.tachikoma/pool
cd broker
    set_broker localhost:4230 <home>/.tachikoma/pool
    set_topic topic1 --num_partitions=1                                 \
                     --replication_factor=1
    set_group cache  --topic=topic1
    start_broker
cd ..


# in-memory cache
make_node ConsumerBroker topic1:consumer --broker=broker                \
                                         --topic=topic1                 \
                                         --group=cache                  \
                                         --default_offset=start         \
                                         --max_unanswered=0
make_node Table          topic1:table    --window_size=0                \
                                         --num_buckets=1
connect_node topic1:consumer topic1:table
connect_edge topic1:consumer topic1:table


# http interface
connect_inet localhost:4230 localhost:4230
make_node HTTP_Responder http:responder /tmp/http 4242
make_node HTTP_Timeout   http:timeout
make_node Tee            access:log
make_node HTTP_Route     root
make_node HTTP_Fetch     root:dir       /         topic1:table
make_node HTTP_Store     store:dir      /tmp/http /store topic1
make_node HTTP_Sigma     sigma
make_node Topic          topic1         localhost:4230/broker
command root add /      root:dir
command root add /store store:dir
command root add /sigma sigma
connect_node http:responder root
listen_inet --io 0.0.0.0:4242
connect_sink 0.0.0.0:4242 http:responder


secure 2
